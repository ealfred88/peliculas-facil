<!-- sections/home-pelicula-residencial.liquid -->

{%- style -%}
  .pelicula-residencial {
    background-color: #fff;
    border-radius: 20px;
    margin-top: 40px;
    padding: 48px;
  }
  .pelicula-residencial__content {
    display: flex;
    gap: 40px;
    align-items: flex-start;
  }
  .pelicula-residencial__image {
    flex: 0 0 400px;
  }
  .pelicula-residencial__image img {
    width: 100%;
    height: auto;
    border-radius: 10px;
  }
  .pelicula-residencial__details {
    flex: 1;
  }
  .pelicula-residencial__title {
    color: #000;
    font-size: 28px;
    font-weight: 600;
    margin: 0;
  }
  .pelicula-residencial__subtitle {
    color: #000;
    font-size: 16px;
    margin: 8px 0;
    font-weight: 600;
  }
  .pelicula-residencial__price {
    font-size: 32px;
    font-weight: 600;
    color: #5ABB46;
    line-height: 1;
    margin-bottom: 24px;
  }
  .variant-list {
    margin-bottom: 14px;
  }
  .variant-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  .variant-item:last-child {
    border-bottom: none;
  }
  .variante-item {
    margin-bottom: 12px;
  }
  .variant-number {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
    margin-right: 16px;
  }
  .variant-options {
    display: flex;
    gap: 16px;
    flex: 1;
  }
  .variant-option {
    flex: 1;
  }
  .variant-option label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
  }
  .variant-option select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
  }
  .variant-remove {
    width: 32px;
    height: 40px;
    color: #ff4444;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    margin-left: 16px;
  }
  .add-variant-btn {
    text-decoration: underline;
    cursor: pointer;
    font-size: 14px;
    margin-bottom: 24px;
  }
  .variant-summary {
    background: #eee;
    padding: 24px;
    border-radius: 8px;
    margin-bottom: 24px;
  }
  .variant-summary-total {
  
  }
  .variant-summary-row-quantity {
    width: 120px;
    display: flex;
    justify-content: center;
    text-align: center;
  }
  .variant-summary-row-price {
    width: 120px;
  }
  #valor-total {
    font-size: 24px;
    font-weight: 600;
    color: #5ABB46;
    line-height: 1;
  }
  .condicao-parcela {
    font-size: 14px
  }
  .action-buttons {
    height: 40px;
    display: flex;
    gap: 16px;
  }
  .btn-comprar {
    background: #5ABB46;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    height: 100%;
    transition: background 0.3s ease, color 0.3s ease;
  }
  .btn-comprar:hover {
    background: #3B6330;
    color: #fff;
  }
  .btn-detalhes {
    background: transparent;
    color: #000;
    padding: 8px 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 16px;
    height: 100%;
    transition: background 0.3s ease, color 0.3s ease;
  }
  .btn-detalhes:hover {
    background: #215AA8;
    color: #fff;
    border: 1px solid #215AA8;
  }
{%- endstyle -%}

{% comment %} Buscar produto das configurações ou produto padrão {% endcomment %}
{% if section.settings.featured_product %}
  {% assign target_product = section.settings.featured_product %}
{% else %}
  {% assign target_product = all_products['pelicula-nano-ceramica-residencial'] %}
  {% unless target_product %}
    {% for product in collections.all.products limit: 1 %}
      {% assign target_product = product %}
      {% break %}
    {% endfor %}
  {% endunless %}
{% endif %}

{% assign section_title = section.settings.section_title | default: 'Película Nano Cerâmica Residencial' %}
{% assign section_subtitle = section.settings.section_subtitle | default: 'Compra por metro ²' %}
{% assign max_installments = section.settings.max_installments | default: 5 %}

<section class="container pelicula-residencial">
  {% if target_product %}
    <div class="pelicula-residencial__content">
      <div class="pelicula-residencial__image">
        <img 
          src="{{ target_product.featured_image | image_url: width: 600 }}" 
          alt="{{ target_product.title }}"
          width="600"
          height="400"
        />
      </div>
      
      <div class="pelicula-residencial__details">
        <h2 class="pelicula-residencial__title">{{ section_title }}</h2>
        <p class="pelicula-residencial__subtitle">{{ section_subtitle }}</p>
        
        <div class="pelicula-residencial__price">
          R$ {{ target_product.price | money_without_currency | replace: ',', '.' }}m²
          <small style="font-size: 14px; color: #000; font-weight: 400;">em até {{ max_installments }}x <b>sem juros</b></small>
        </div>
        
        <form action="{{ routes.cart_add_url }}" method="post" id="variant-form">
          <div class="variant-list" id="variant-list">
            <div class="d-flex justify-content-center align-items-end variante-item" data-variant-index="1">
              <div class="variant-number">1</div>
              <div class="variant-options">
                <div class="variant-option">
                  <label>Largura:</label>
                  <select name="largura_1" data-option="largura">
                    {% for option in target_product.options %}
                      {% if option contains 'Largura' or option contains 'largura' %}
                        {% for value in target_product.options[forloop.index0].values %}
                          <option value="{{ value }}">{{ value }}</option>
                        {% endfor %}
                      {% else %}
                        <option value="1,42 m">1,42 m</option>
                        <option value="1,52 m">1,52 m</option>
                      {% endif %}
                      {% break %}
                    {% endfor %}
                  </select>
                </div>
                <div class="variant-option">
                  <label>Altura:</label>
                  <select name="altura_1" data-option="altura">
                    <option value="50 cm">50 cm</option>
                    <option value="60 cm">60 cm</option>
                    <option value="70 cm">70 cm</option>
                    <option value="80 cm">80 cm</option>
                    <option value="90 cm">90 cm</option>
                    <option value="100 cm">100 cm</option>
                  </select>
                </div>
                <div class="variant-option">
                  <label>Quantidade:</label>
                  <select name="quantidade_1" data-option="quantidade">
                    {% for i in (1..20) %}
                      <option value="{{ i }}" {% if i == 10 %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="variant-option">
                  <label>Tonalidade:</label>
                  <select name="tonalidade_1" data-option="tonalidade">
                    {% for variant in target_product.variants limit: 5 %}
                      {% if variant.title != 'Default Title' %}
                        <option value="{{ variant.title }}">{{ variant.title }}</option>
                      {% else %}
                        <option value="G 35">G 35</option>
                        <option value="G 50">G 50</option>
                        <option value="G 70">G 70</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="variant-remove" onclick="removeVariant(1)">×</div>
            </div>
          </div>
          
          <div class="add-variant-btn" onclick="addVariant()">
            Incluir novo item
          </div>
          
          <div class="variant-summary d-flex justify-content-between">
            <div class="variant-summary-row variant-summary-row-price d-flex flex-column col-4">
              <span>Valor m²:</span>
              <span id="valor-m2"><b>R$ {{ target_product.price | money_without_currency }}</b></span>
            </div>
            <div class="variant-summary-row variant-summary-row-quantity justify-content-start d-flex flex-column col-4">
              <span>Total itens:</span>
              <span id="total-itens"><b>1</b></span>
            </div>
            <div class="variant-summary-total d-flex flex-column col-4">
              <span>Valor total:</span>
              <span id="valor-total">R$ {{ target_product.price | money_without_currency }}</span>
              <span class="condicao-parcela">Em até {{ max_installments }}x de R$ <span id="parcela">{{ target_product.price | divided_by: max_installments | money_without_currency }}</span> sem juros</span>
            </div>
          </div>
          
          <div class="action-buttons">
            <button type="submit" class="btn-comprar">Comprar</button>
            <a href="{{ target_product.url }}" class="btn-detalhes">Ver mais detalhes</a>
          </div>
          
          <input type="hidden" name="id" value="{{ target_product.selected_or_first_available_variant.id }}" id="selected-variant-id">
        </form>
      </div>
    </div>
  {% else %}
    <div class="pelicula-residencial__content">
      <p>Produto não encontrado. Configure um produto específico nas configurações da seção.</p>
    </div>
  {% endif %}
</section>

<script>
  let variantCounter = 1;
  const basePrice = {{ target_product.price | default: 8990 }};
  const maxInstallments = {{ max_installments }};
  
  function addVariant() {
    variantCounter++;
    const variantList = document.getElementById('variant-list');
    const newVariant = document.createElement('div');
    newVariant.className = 'variante-item d-flex justify-content-center align-items-end';
    newVariant.setAttribute('data-variant-index', variantCounter);
    
    newVariant.innerHTML = `
      <div class="variant-number">${variantCounter}</div>
      <div class="variant-options">
        <div class="variant-option">
          <label>Largura:</label>
          <select name="largura_${variantCounter}" data-option="largura" onchange="updateTotal()">
            <option value="1,42 m">1,42 m</option>
            <option value="1,52 m">1,52 m</option>
          </select>
        </div>
        <div class="variant-option">
          <label>Altura:</label>
          <select name="altura_${variantCounter}" data-option="altura" onchange="updateTotal()">
            <option value="50 cm">50 cm</option>
            <option value="60 cm">60 cm</option>
            <option value="70 cm">70 cm</option>
            <option value="80 cm">80 cm</option>
            <option value="90 cm">90 cm</option>
            <option value="100 cm">100 cm</option>
          </select>
        </div>
        <div class="variant-option">
          <label>Quantidade:</label>
          <select name="quantidade_${variantCounter}" data-option="quantidade" onchange="updateTotal()">
            ${Array.from({length: 20}, (_, i) => `<option value="${i+1}" ${i === 9 ? 'selected' : ''}>${i+1}</option>`).join('')}
          </select>
        </div>
        <div class="variant-option">
          <label>Tonalidade:</label>
          <select name="tonalidade_${variantCounter}" data-option="tonalidade" onchange="updateTotal()">
            <option value="G 35">G 35</option>
            <option value="G 50">G 50</option>
            <option value="G 70">G 70</option>
          </select>
        </div>
      </div>
      <div class="variant-remove" onclick="removeVariant(${variantCounter})">×</div>
    `;
    
    variantList.appendChild(newVariant);
    updateTotal();
  }
  
  function removeVariant(index) {
    const variants = document.querySelectorAll('.variant-item');
    if (variants.length > 1) {
      document.querySelector(`[data-variant-index="${index}"]`).remove();
      updateTotal();
    }
  }
  
  function updateTotal() {
    const variants = document.querySelectorAll('.variant-item');
    let totalItems = 0;
    let totalValue = 0;
    
    variants.forEach(variant => {
      const quantidade = parseInt(variant.querySelector('[data-option="quantidade"]').value) || 1;
      const largura = parseFloat(variant.querySelector('[data-option="largura"]').value.replace(/[^\d,]/g, '').replace(',', '.')) || 1.42;
      const altura = parseFloat(variant.querySelector('[data-option="altura"]').value.replace(/[^\d]/g, '')) / 100 || 0.5;
      
      const area = largura * altura;
      const itemValue = area * (basePrice / 100);
      
      totalItems += quantidade;
      totalValue += itemValue * quantidade;
    });
    
    document.getElementById('total-itens').textContent = totalItems;
    document.getElementById('valor-total').textContent = `R$ ${totalValue.toFixed(2).replace('.', ',')}`;
    document.getElementById('parcela').textContent = `${(totalValue / maxInstallments).toFixed(2).replace('.', ',')}`;
  }
  
  // Adicionar event listeners para os selects iniciais
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('select[data-option]').forEach(select => {
      select.addEventListener('change', updateTotal);
    });
    updateTotal();
  });
</script>

{% schema %}
  {
    "name": "Home Película Residencial",
    "tag": "section",
    "settings": [
      {
        "type": "product",
        "id": "featured_product",
        "label": "Produto em Destaque",
        "info": "Selecione o produto que será exibido nesta seção"
      },
      {
        "type": "text",
        "id": "section_title",
        "label": "Título da Seção",
        "default": "Película Nano Cerâmica Residencial"
      },
      {
        "type": "text",
        "id": "section_subtitle",
        "label": "Subtítulo",
        "default": "Compra por metro ²"
      },
      {
        "type": "range",
        "id": "max_installments",
        "label": "Número máximo de parcelas",
        "min": 1,
        "max": 12,
        "step": 1,
        "default": 5
      }
    ],
    "presets": [
      {
        "name": "Home Película Residencial",
        "category": "Custom"
      }
    ]
  }
{% endschema %}